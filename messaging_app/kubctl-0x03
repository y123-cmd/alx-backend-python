#!/bin/bash

DEPLOYMENT="messaging-app-blue"
SERVICE_URL="http://$(minikube ip):$(kubectl get svc messaging-app-service -o=jsonpath='{.spec.ports[0].nodePort}')"

echo "ğŸš€ Applying updated deployment..."
kubectl apply -f blue_deployment.yaml

echo "â³ Monitoring rollout progress..."
kubectl rollout status deployment/$DEPLOYMENT

echo "ğŸ“¡ Starting downtime test..."
(
  while true; do
    curl -s -o /dev/null -w "%{http_code} " $SERVICE_URL
    sleep 1
  done
) &

TEST_PID=$!

echo "ğŸ’¤ Waiting for update to finish..."
kubectl rollout status deployment/$DEPLOYMENT

kill $TEST_PID

echo "âœ… Rolling update complete. Current pods:"
kubectl get pods -l app=messaging-app
