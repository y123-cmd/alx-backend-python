#!/bin/bash
# kubctl-0x01 - Scale Django messaging app in Kubernetes and verify

set -e  # Exit on any error

DEPLOYMENT_NAME="messaging-app-deployment"
REPLICAS=3
SERVICE_NAME="messaging-app-service"
SERVICE_PORT=8000

echo "Scaling $DEPLOYMENT_NAME to $REPLICAS replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=$REPLICAS

echo "Verifying pods..."
kubectl get pods -l app=messaging-app -o wide

echo "Waiting for all pods to be ready..."
kubectl rollout status deployment "$DEPLOYMENT_NAME"

echo "Checking cluster resource usage..."
if ! command -v kubectl-top &> /dev/null && ! kubectl top nodes &> /dev/null; then
    echo "Metrics server not found. Please install it: https://github.com/kubernetes-sigs/metrics-server"
else
    kubectl top pods
fi

echo "Performing load testing with wrk..."
if ! command -v wrk &> /dev/null; then
    echo "wrk is not installed. Install it first: https://github.com/wg/wrk"
else
    echo "Fetching service URL from Minikube..."
    APP_URL=$(minikube service "$SERVICE_NAME" --url | head -n 1)
    echo "Testing $APP_URL"
    wrk -t4 -c100 -d30s "$APP_URL"
fi

echo "Done."
